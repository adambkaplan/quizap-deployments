apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: shipwright-build

resources:
  - https://github.com/shipwright-io/build/releases/download/v0.17.0/release.yaml
  - cert-manager

patches:
  - path: crds/patches/inject_ca_buildruns.yaml
  - path: crds/patches/inject_ca_builds.yaml
  - path: crds/patches/inject_ca_buildstrategies.yaml
  - path: crds/patches/inject_ca_clusterbuildstrategies.yaml


replacements:
  - source: # Uncomment the following block if you have any webhook
      kind: Service
      version: v1
      name: shp-build-webhook
      fieldPath: .metadata.name # Name of the service
    targets:
      - select:
          kind: Certificate
          group: cert-manager.io
          version: v1
          name: shipwright-build-webhook-cert
        fieldPaths:
          - .spec.dnsNames.0
          - .spec.dnsNames.1
        options:
          delimiter: '.'
          index: 0
          create: true
  - source:
      kind: Service
      version: v1
      name: shp-build-webhook
      fieldPath: .metadata.namespace # Namespace of the service
    targets:
      - select:
          kind: Certificate
          group: cert-manager.io
          version: v1
          name: shipwright-build-webhook-cert
        fieldPaths:
          - .spec.dnsNames.0
          - .spec.dnsNames.1
        options:
          delimiter: '.'
          index: 1
          create: true
  # Every CRD needs to be "replaced" with the certificate namespace and name to get the CA inejected
  # BuildRuns
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.namespace # Namespace of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: buildruns.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 0
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.name # Name of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: buildruns.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 1
  # Builds
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.namespace # Namespace of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: builds.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 0
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.name # Name of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: builds.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 1
  # BuildStrategies
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.namespace # Namespace of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: buildstrategies.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 0
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.name # Name of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: buildstrategies.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 1
  # ClusterBuildStrategies
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.namespace # Namespace of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: clusterbuildstrategies.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 0
  - source: # Uncomment the following block if you have a ConversionWebhook (--conversion)
      kind: Certificate
      group: cert-manager.io
      version: v1
      name: shipwright-build-webhook-cert
      fieldPath: .metadata.name # Name of the certificate CR
    targets:
      - select:
          kind: CustomResourceDefinition
          group: apiextensions.k8s.io
          version: v1
          name: clusterbuildstrategies.shipwright.io
        fieldPaths:
          - .metadata.annotations.cert-manager\.io/inject-ca-from
        options:
          delimiter: '/'
          index: 1

metadata:
  name: shipwright-build
  annotations:
    description: "Shipwright installation from latest release"
